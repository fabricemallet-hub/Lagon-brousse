{
  "entities": {
    "UserAccount": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserAccount",
      "type": "object",
      "description": "Represents a user account within the application.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the user account." },
        "email": { "type": "string", "description": "The user's email address.", "format": "email" },
        "displayName": { "type": "string", "description": "The user's public display name." },
        "subscriptionStatus": { "type": "string", "description": "The current subscription status of the user (e.g., 'active', 'inactive', 'trial', 'admin')." },
        "subscriptionStartDate": { "type": "string", "description": "The date when the user's subscription started.", "format": "date-time" },
        "subscriptionExpiryDate": { "type": "string", "description": "The date when the user's subscription expires.", "format": "date-time" },
        "favoriteLocationIds": { "type": "array", "description": "References to Location. (Relationship: UserAccount N:N Location)", "items": { "type": "string" } }
      },
      "required": ["id", "email", "displayName", "subscriptionStatus"]
    },
    "Location": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Location",
      "type": "object",
      "description": "Represents a location (commune) selected by the user.",
      "properties": {
        "id": { "type": "string", "description": "Unique identifier for the location." },
        "name": { "type": "string", "description": "The name of the location." },
        "latitude": { "type": "number", "description": "The latitude of the location." },
        "longitude": { "type": "number", "description": "The longitude of the location." }
      },
      "required": ["id", "name", "latitude", "longitude"]
    },
    "Station": {
      "title": "Station",
      "type": "object",
      "description": "Represents a tide station with its coordinates.",
      "properties": {
        "name": { "type": "string" },
        "lat": { "type": "number" },
        "lon": { "type": "number" }
      }
    },
    "TideArchive": {
      "title": "TideArchive",
      "type": "object",
      "description": "Contains the tide events for a specific day and station.",
      "properties": {
        "tides": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "type": { "type": "string" },
              "time": { "type": "string" },
              "height": { "type": "number" }
            },
            "required": ["type", "time", "height"]
          }
        }
      }
    },
    "HuntingSession": {
      "title": "HuntingSession",
      "type": "object",
      "description": "Represents a real-time hunting session.",
      "properties": {
        "code": { "type": "string", "description": "A unique, 6-character code for joining the session." },
        "organizerId": { "type": "string", "description": "The UID of the user who created the session." },
        "createdAt": { "type": "string", "format": "date-time", "description": "Timestamp of when the session was created." },
        "expiresAt": { "type": "string", "format": "date-time", "description": "Timestamp when the session expires and should be deleted by TTL." }
      },
      "required": ["code", "organizerId", "createdAt", "expiresAt"]
    },
    "SessionParticipant": {
      "title": "SessionParticipant",
      "type": "object",
      "description": "Represents a participant in a hunting session.",
      "properties": {
        "displayName": { "type": "string", "description": "The display name of the participant." },
        "location": {
          "type": "object",
          "properties": {
            "latitude": { "type": "number" },
            "longitude": { "type": "number" }
          }
        },
        "battery": {
          "type": "object",
          "properties": {
            "level": { "type": "number", "description": "Battery level from 0 to 1." },
            "charging": { "type": "boolean", "description": "Is the device charging." }
          }
        },
        "updatedAt": { "type": "string", "format": "date-time", "description": "Last update timestamp." }
      },
      "required": ["displayName", "updatedAt"]
    }
  },
  "auth": {
    "providers": ["password"]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserAccount",
          "schema": { "$ref": "#/backend/entities/UserAccount" },
          "description": "Stores user account information. The 'userId' path parameter is used to enforce path-based ownership for data privacy. Includes 'favoriteLocationIds' array.",
          "params": [{ "name": "userId", "description": "The unique identifier for the user account." }]
        }
      },
      {
        "path": "/locations/{locationId}",
        "definition": {
          "entityName": "Location",
          "schema": { "$ref": "#/backend/entities/Location" },
          "description": "Stores location data (communes).",
          "params": [{ "name": "locationId", "description": "The unique identifier for the location." }]
        }
      },
      {
        "path": "/stations/{stationId}",
        "definition": {
          "entityName": "Station",
          "schema": { "$ref": "#/backend/entities/Station" },
          "description": "Stores tide station metadata like name and coordinates.",
          "params": [{ "name": "stationId", "description": "The unique identifier for the tide station (e.g., 'Noumea')." }]
        }
      },
      {
        "path": "/stations/{stationId}/tides/{date}",
        "definition": {
          "entityName": "TideArchive",
          "schema": { "$ref": "#/backend/entities/TideArchive" },
          "description": "A subcollection storing daily tide data for a station. The document ID is the date in YYYY-MM-DD format.",
          "params": [
            { "name": "stationId", "description": "The ID of the parent station." },
            { "name": "date", "description": "The date of the tide data in YYYY-MM-DD format." }
          ]
        }
      },
      {
        "path": "/hunting_sessions/{sessionId}",
        "definition": {
          "entityName": "HuntingSession",
          "schema": { "$ref": "#/backend/entities/HuntingSession" },
          "description": "Stores hunting session metadata. Documents have a TTL based on the 'expiresAt' field.",
          "params": [{ "name": "sessionId", "description": "The unique ID for the hunting session." }]
        }
      },
      {
        "path": "/hunting_sessions/{sessionId}/participants/{userId}",
        "definition": {
          "entityName": "SessionParticipant",
          "schema": { "$ref": "#/backend/entities/SessionParticipant" },
          "description": "Stores real-time data for each participant in a session. The document ID is the user's UID.",
          "params": [
            { "name": "sessionId", "description": "The ID of the parent session." },
            { "name": "userId", "description": "The participant's user ID." }
          ]
        }
      }
    ],
    "reasoning": "This design prioritizes security and scalability for the Marées et Terroir Calédonien application, focusing on user authentication and location data. It leverages path-based ownership for user accounts and separates location data for efficient querying and management. The design emphasizes authorization independence by not relying on `get()` calls in security rules.\n\n**Authorization Independence:** User account data is stored under `/users/{userId}`, ensuring clear ownership and avoiding reliance on external document data for authorization. No data is denormalized as the only relationship is a N:N relationship between user and location and this handled within the user document as an array of IDs.\n\n**Structural Segregation:**  User account data is kept separate from location data, allowing for distinct security rules tailored to each data type.\n\n**QAPs (Query Across Partitions):** Because there are no list operations required for UserAccount collection and favoriteLocationIds only stores the references to existing locations, QAP is automatically supported. List operation on the location data is supported given there is no restriction on listing locations, thus no need to store the role in database."
  }
}
